(function(){"use strict";var e="init",t="autofill",n="getRewardBalance",r="getRewardFeatureBalance",i="getReward",s="open",o="close",u="subscribe",a="NOCONTENT",f="EMBED",l="POPUP",c="DEMO",h="DEMO_EMBED",p=l,d="squatch_open",v="_IGNORE_",m="UNREGISTERED",g=!1,y,b={},w=!1,E=!1,S=null,x=null,T=!0,N=!1,C=function(){N&&window.console&&console.log.apply(console,arguments)};if(!window.console||!console.log)console={log:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){}};var k=function(){arguments[0].readyState==0?console.error("Failed to load script"):console.error("Failed to parse script: "+arguments[2].toString())},L=function(a){var f;a instanceof Array?f=a[0]:f=a;switch(f){case e:U(a[1]);break;case t:z(a[1]);break;case n:$(a[1],a[2]);break;case r:J(a[1],a[2]);break;case i:W(a[1]);break;case s:P();break;case o:H();break;case u:K(a[1],a[2]);break;default:console.error("Unknown method call `"+f+"`. Valid options are [init,autofill,getReward,getRewardBalance]")}},A=function(t){t(document).ready(function(t){x=t;for(var n=0;n<window._sqh.length;n++){var r=window._sqh[n];r[0]==u&&(L(r),window._sqh.splice(n,1))}var i=-1;for(var n=0;n<window._sqh.length;n++){var r=window._sqh[n];if(r[0]==e){L(r),i=n;break}}i>-1?window._sqh.splice(i,1):console.error('Could not find "init" in the _sqh queue when squatch.js was loaded.')})},O=function(e){if(typeof e!="undefined"&&e)return;var t=window._sqh.shift();while(t)L(t),t=window._sqh.shift();window._sqh.push=function(){for(var e=0;e<arguments.length;e++)L(arguments[e]);return Array.prototype.push.apply(this,arguments)}},M=function(e,t){window._sqh.push([e,t])},_=function(e){var t=typeof e.host=="undefined"?location.protocol+"//app.referralsaasquatch.com":location.protocol+"//"+e.host;return t+"/a/"+e.tenant_alias+"/"},D=function(e){C("loading cookie code widget");var t=_(e)+"widgets/squatchcookie",n=new window.easyXDM.Rpc({remote:t},{local:{init:function(e){C("got init message"),S={code:e},O(!1)}}})},P=function(){x("#squatchModalWrapper").length>0?x("#squatchModalWrapper").trigger("squatch:open"):console.error("The squatch widget must be loaded in popup mode to be opened")},H=function(){x("#squatchModalWrapper").length>0?x("#squatchModalWrapper").trigger("squatch:close"):console.error("The squatch widget must be loaded in popup mode to be closed")},B=function(e){var t=e.auto_open_param?e.auto_open_param:d,n=window.location.search.substring(1),r=n.split("&");for(var i=0;i<r.length;i++)if(r[i]===t)var s=setInterval(function(){x(document).ready(function(){P(),g=!0}),g&&clearInterval(s)},1e3)},j=function(e,t){var n,r;e.payment_provider_id==v?(n=e.account_id,r=v):e.payment_provider_id==m?(n=v,r=e.account_id):(n=e.payment_provider_id,r=e.account_id===null?"":e.account_id);var i;return r!=v?i="systemId="+encodeURIComponent(r)+(n!=v?"&paymentProviderId="+encodeURIComponent(n):""):i=n!=v?"paymentProviderId="+encodeURIComponent(n):"",_(e)+"widgets/squatchwidget?"+i+"&userId="+encodeURIComponent(e.user_id)+(e.email!=v?"&email="+encodeURIComponent(e.email):"")+"&firstName="+encodeURIComponent(e.first_name)+"&lastName="+encodeURIComponent(e.last_name)+(e.user_image!=v?"&userImage="+encodeURIComponent(e.user_image):"")+(e.checksum!=v?"&paramChecksum="+encodeURIComponent(e.checksum):"")+(e.locale!=v?"&locale="+encodeURIComponent(e.locale):"")+(e.fb_share_image!=v?"&fbShareImage="+encodeURIComponent(e.fb_share_image):"")+(e.account_status!=v?"&accountStatus="+encodeURIComponent(e.account_status):"")+(e.referral_code!=v?"&referralCode="+encodeURIComponent(e.referral_code):"")+"&pageType="+t+"&mode="+e.mode},F=function(e,t,n,r,i){var s=j(e,i),o=new window.easyXDM.Rpc({remote:s,container:t,props:{allowtransparency:"true",scrolling:"no",marginwidth:"0",marginheight:"0",frameborder:"no"}},{local:{init:function(r,i,s,o,u){C("got init message"),T=u,t.getElementsByTagName("iframe")[0].style.height=r+"px",t.getElementsByTagName("iframe")[0].style.width=e.mode!=f&&e.mode!=h||!!T?i+"px":"100%",S={code:s,rewardBalance:o},n(!1)},resize:function(n,r){C("got resize message"),t.getElementsByTagName("iframe")[0].style.height=n+"px",t.getElementsByTagName("iframe")[0].style.width=e.mode!=f&&e.mode!=h||!!T?r+"px":"100%",x(window).trigger("resize.modal")},publish:function(e,t){C("got publish message");if(b[e])for(var n=0;n<b[e].length;n++)b[e][n](t)},close:function(){C("got close message"),r()},error:function(r,i,s){console.error(r),T=!1,t.getElementsByTagName("iframe")[0].style.height=e.mode==f||e.mode==h?"100%":i+"px",t.getElementsByTagName("iframe")[0].style.width=e.mode==f||e.mode==h?"100%":s+"px",n(!0)}},remote:{openedWidget:{},closedWidget:{}}});return o},I=function(e){var t=j(e,""),n=document.createElement("div");x("<div></div>").hide().append(n).appendTo("body");var r=new window.easyXDM.Rpc({remote:t,container:n,props:{allowtransparency:"true",scrolling:"no",marginwidth:"0",marginheight:"0",frameborder:"no"}},{local:{init:function(e,t){C("got init message"),S={code:e,reward:t},O(!1)},error:function(e){console.error(e)}}})},q=function(e){C("loading embed widget");if(x("#squatchembed").length>0){var t=document.createElement("div");x("<div></div>").hide().attr("id","squatchEmbedWrapper").append(t).insertAfter(x("#squatchembed"));var n=function(e){setTimeout(function(){x("#squatchembed").hide(),x("#squatchEmbedWrapper").show(),O(e)},500)},r=F(e,t,n,function(){},"embeddedWidget");r.openedWidget(e.mode,e.user_id,e.account_id)}else e.mode=a,I(e)},R=function(e){C("loading popup widget");var t=x("<link>",{rel:"stylesheet",type:"text/css",href:y+"/assets/css/widget/external/reveal.min.css"});t.appendTo("head"),x.getScript(y+"/assets/javascripts-min/reveal.js",function(){C("reveal loaded");var t=document.createElement("div");t.setAttribute("id","squatchModal"),t.setAttribute("class","reveal-modal"),x("<div></div>").attr("id","squatchModalWrapper").append(t).appendTo("body");var n=function(){x("#squatchModalWrapper").trigger("squatch:close")},r=F(e,t,O,n,"modalPopup");x("#squatchModalWrapper").on("reveal:close","#squatchModal",function(){r.closedWidget()}),x("body").on("click",".squatchpop",function(e){e.preventDefault(),x("#squatchModalWrapper").trigger("squatch:open")}),x("#squatchModalWrapper").on("squatch:close",function(e){x("#squatchModal").trigger("reveal:close")}),x("#squatchModalWrapper").on("squatch:open",function(t){r.openedWidget(e.mode,e.user_id,e.account_id),x("#squatchModal").reveal()}),B(e)}).fail(k)},U=function(e){if(w){C("Should not call init more than once");return}w=!0,e.tenant_alias||console.error("tenant_alias must be set"),typeof e.autofill!="undefined"&&M(t,e.autofill);var n;if(typeof e.account_id=="undefined")n=D;else{E=!0;if(!e.user_id||!e.first_name){console.error("The user_id, email, first_name must be set");return}e.last_name||(C("No last name set. Defaulting to empty"),e.last_name=""),typeof e.email=="undefined"&&(e.email=v),typeof e.payment_provider_id=="undefined"?e.payment_provider_id=v:e.payment_provider_id===null&&(C("Payment provider id provided, but is null. Default to special value"),e.payment_provider_id=m),typeof e.checksum=="undefined"?(e.checksum=v,e.user_image&&e.user_image.len>0&&console.error("User images will not be accepted without signed requests.")):e.checksum||(console.error("Checksum not set properly for signed widget request."),e.checksum=""),typeof e.user_image=="undefined"?e.user_image=v:e.user_image||(C("No user profile image set. Defaulting to gravatar"),e.user_image=""),typeof e.fb_share_image=="undefined"?e.fb_share_image=v:e.fb_share_image||(C("No fb share image set. Defaulting to no image"),e.fb_share_image=""),typeof e.account_status=="undefined"?e.account_status=v:e.account_status||(C("No account_status set. Defaulting to no account_status"),e.account_status=""),typeof e.referral_code=="undefined"?e.referral_code=v:e.referral_code||(C("No account_status set. Defaulting to no account_status"),e.referral_code=""),typeof e.locale=="undefined"?e.locale=v:e.locale||(C("No locale set. Defaulting to no locale"),e.locale=""),e.mode=e.mode||e.mode===0?e.mode:p;switch(e.mode){case a:n=I;break;case f:n=q;break;case l:n=R;break;case c:n=R;break;case h:n=q;break;default:console.error("Unsupported mode: '"+e.mode+"'. Please initialize with one of the following modes: 'NOCONTENT', 'EMBED', or 'POPUP'")}}n&&(x.ajaxSetup({cache:!0}),x.getScript(y+"/assets/javascripts/easyXDM.min.js",function(){C("easyXDM loaded"),n(e)}).fail(k))},z=function(e){typeof e=="string"?S.code&&x(e).val(S.code):typeof e=="function"?e(S.code):console.error('The "autofill" method should be called with either a jQuery selector or a callback. Unknown type '+typeof e)},W=function(e){typeof e=="function"?E?e(X()):console.error("Unsupported reward lookup widget push, you need to push with an account Id to use this feature"):console.error("Unsupported widget reward lookup push, invalid params.")},X=function(){var e={};if(S.rewardBalance)for(var t=0;t<S.rewardBalance.length;t++)S.rewardBalance[t].type=="PCT_DISCOUNT"&&(e=S.rewardBalance[t]);else console.warn("Reward balance could not be found, it may not be implemented in your widget theme.");return typeof e.type!="undefined"?{type:"PCT_DISCOUNT",details:{discountPercentage:e.totalDiscountPercent,referrerDiscountPercent:e.referrerDiscountPercent,referredDiscountPercent:e.referredDiscountPercent}}:{type:"PCT_DISCOUNT",details:{discountPercentage:0,referrerDiscountPercent:0,referredDiscountPercent:0}}},V=function(e){var t=[];if(S.rewardBalance)for(var n=0;n<S.rewardBalance.length;n++)S.rewardBalance[n].type==e&&t.push(S.rewardBalance[n]);else console.warn("Reward balance could not be found, it may not be implemented in your widget theme.");return t},$=function(e,t){E?typeof e=="string"?typeof t=="function"?t(V(e)):console.error("Unsupported widget reward type lookup push, invalid params."):typeof e=="function"?e(S.rewardBalance):console.error("Unsupported widget reward lookup push, invalid params."):console.error("Unsupported reward lookup widget push, you need to push with an account Id to use this feature")},J=function(e,t){if(E)if(typeof e=="string"&&typeof t=="function"){var n=V("FEATURE"),r=[];for(var i=0;i<n.lenght;i++)n[i].featureType==e&&r.push(n[i]);t(r)}else console.error("Unsupported widget reward type lookup push, invalid params.");else console.error("Unsupported reward lookup widget push, you need to push with an account Id to use this feature")},K=function(e,t){b[e]||(b[e]=[]),b[e].push(t)},Q=function(e){if(!e){console.error("Could not find properly formatted squatch.js DOM scripts");return}y=e.match(new RegExp("https?://[^/]*"))[0];var t=function(){window.squatchQuery=window.jQuery.noConflict(!0),A(window.squatchQuery)},n=new RegExp("[1].[7-9](.[0-9])?");if(window.jQuery===undefined||!n.test(window.jQuery.fn.jquery)){var r=document.createElement("script");r.setAttribute("type","text/javascript"),r.setAttribute("src",y+"/assets/javascripts/jquery-1.9.0.min.js"),r.readyState?r.onreadystatechange=function(){(this.readyState=="complete"||this.readyState=="loaded")&&t()}:r.onload=t,(document.getElementsByTagName("head")[0]||document.documentElement).appendChild(r)}else A(window.jQuery)},G=function(e){var t=document.getElementsByTagName("script"),n=t.length,r=/squatch(\.min)?\.js(\?.*)*$/,i,s;while(n--){i=t[n].src;if(i&&i.match(r)){s=i;break}}s||e<=0?Q(s):(C("squatch js not finished loading try again."),setTimeout(function(){G(--e)},50))};typeof _sqh=="undefined"?console.error("_sqh must be defined and initialized to use this widget.\nTo initialize the popup widget call: _sqh.push(['init', {tenant_alias: '$yourTenantAlias', account_id: '$viewingCustomerAccountId', email: '$viewingCustomerEmail', user_id : '$viewingUserId', first_name: '$viewingCustomerFirstName', last_name: '$viewingCustomerLastName']}]);"):G(10)})();